import React, { useMemo, useState, useRef, useEffect } from 'react'
import Checkbox from '../../components/Checkbox/Checkbox'
import { useFileNavigation } from '../../contexts/FileNavigationContext'
import { useSelection } from '../../contexts/SelectionContext'
import { useTranslation } from '../../contexts/TranslationProvider'
import { useOptions } from '../../contexts/OptionsContext'
import { FaEllipsisV } from 'react-icons/fa'
import  {HeaderSelector} from '../../components/HeaderSelector/HeaderSelector'
import { createPortal } from 'react-dom'

const FilesHeader = ({ space, spaces, unselectFiles, onSort, sortConfig, onHeaderChangeWidth, onHeaderRemove, onHeadersReset, fontFamily }) => {
    const t = useTranslation()
    const [ showSelectAll, setShowSelectAll ] = useState(false)
    const { options } = useOptions()
    const { selectedFiles, setSelectedFiles } = useSelection()
    const { currentPathFiles } = useFileNavigation()

    const [ draggingColumn, setDraggingColumn ] = useState(undefined)    
    const [ colNameWidth, setColNameWidth ]  = useState(`calc(${spaces.get(space)?.width||10}% - 60px)`)
    const [ colNameInitialWidth, setColNameInitialWidth ]  = useState(0)
    const [ colWidth, setColWidth ]  = useState({})
    const [ colInitialWidth, setColInitialWidth ]  = useState({})
    
    const [ mousePos, setMousePos ]  = useState(0)
    const [ headerSelectorVisible, setHeaderSelectorVisible ]  = useState(false)
    const containerRef = useRef(null)
    const anchorRef = useRef(null);

    const allFilesSelected = useMemo(() => {
        return (currentPathFiles.length > 0) && (selectedFiles.length === currentPathFiles.length)
    }, [selectedFiles, currentPathFiles])

    useEffect( () => {
        let allWidths = {}
        spaces.get(space)?.properties.filter(p => p.visible).map(p =>{
            allWidths[p.name] = `calc(${p.width}%)`
        })
        setColInitialWidth(allWidths)
    }, [])

    const handleSelectAll = (e) => {
        if (e.target.checked) {
            setSelectedFiles(currentPathFiles)
            setShowSelectAll(true)
        }
        else {
            unselectFiles()
        }
    }

    const handleSort = (key, format) => {
        if (onSort) onSort(key, format)
    }

    const handleMouseDown = (e, name) => {
        setDraggingColumn(name)
        let el = document.getElementById('col-'+name)
        if (name==='name') {
            setColNameInitialWidth(el.offsetWidth)
        }
        else {
            colInitialWidth[name]=el.offsetWidth
            setColInitialWidth({...colInitialWidth})
        }
        setMousePos(e.clientX)
    }

    const handleMouseUp = () => {
        setDraggingColumn(undefined)
    }

    const handleMouseMove = (e) => {
        if (draggingColumn===undefined) return
        e.preventDefault()

        let padding = options.checkBox? 15 : 35
        if (draggingColumn==='name') {
            let newWidth=colNameInitialWidth+e.clientX-mousePos-padding
            setColNameWidth(newWidth)
            onHeaderChangeWidth(draggingColumn, newWidth)
        }
        else {
            let newWidth=colInitialWidth[draggingColumn]+e.clientX-mousePos
            if (newWidth>0) {
                colWidth[draggingColumn] = newWidth
                setColWidth({...colWidth})
                onHeaderChangeWidth(draggingColumn, newWidth)
            }
        }
    }

    return (
        <div className='files-header' onMouseOver={() => setShowSelectAll(true)} onMouseLeave={() => setShowSelectAll(false)} >
            {
                options.checkBox && <div className='file-select-all'>
                    {(showSelectAll || allFilesSelected) && (
                    <Checkbox
                        id='selectAll'
                        checked={allFilesSelected}
                        onChange={handleSelectAll}
                        title='Select all'
                        disabled={currentPathFiles.length === 0}
                    />
                    )}
                </div>
            }
            <section
                ref={containerRef}
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                className="files-container"
                >

                {/* object name */}
                <div id='col-name' className={`${sortConfig?.key === 'name' ? 'active' : ''}`} style={{ width: colNameWidth, paddingLeft: options.checkBox? '15px':'35px'}} onClick={() => handleSort('name', 'string')}>
                    {spaces.get(space)?.text||''}
                    {sortConfig?.key === 'name' && (
                        <span className='sort-indicator'>{sortConfig.direction === 'asc' ? ' ▲' : ' ▼'}</span>
                    )}
                </div>
                <div
                    className={`column-resize ${draggingColumn ? "column-dragging" : ""}`}
                    onMouseDown={(e) => handleMouseDown(e,'name')}
                />

                {/* object props */}
                { spaces.get(space)?.properties.filter(p => p.visible).map((property) => {
                    return (<React.Fragment key={property.name}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: colWidth[property.name]||property.width+'%'}}>
                            
                                <div  id={'col-'+property.name} className={`${sortConfig?.key === property.source ? 'active' : ''}`} style={{ width: '100%'}} onClick={() => { if (property.sortable) handleSort(property.source, property.format)}}>
                                        {property.text}
                                        {property.sortable && sortConfig?.key === property.source && (
                                            <span className='sort-indicator'>{sortConfig.direction === 'asc' ? ' ▲' : ' ▼'}</span>
                                        )}
                                </div>
                                { property.removable && 
                                    <span style={{ color: '#dddddd', cursor: 'pointer', transition: '0.3s', paddingRight: '4px' }}
                                            onMouseEnter={(e) => (e.currentTarget.style.color = 'black')}
                                            onMouseLeave={(e) => (e.currentTarget.style.color = '#dddddd')}
                                            onClick={e => onHeaderRemove(space, property.name)}
                                    >
                                        x
                                    </span>
                                }

                            </div>                            
                            <div
                                className={`column-resize ${draggingColumn ? "column-dragging" : ""}`}
                                onMouseDown={(e) => handleMouseDown(e, property.name)}
                            />
                        </React.Fragment>
                    )
                })}
                {/* config */}
                { spaces.get(space)?.configurable?
                    <span ref={anchorRef}>
                        <FaEllipsisV style={{cursor:'pointer'}} onClick={() => setHeaderSelectorVisible(true)}/>
                    </span>
                    :
                    <></>
                }
                {headerSelectorVisible && createPortal(
                    <div style={{
                        position: 'fixed',
                        top: anchorRef.current?.getBoundingClientRect().bottom + 2,
                        left: anchorRef.current?.getBoundingClientRect().left+15,
                        zIndex: 9999,
                        fontFamily,
                        backgroundColor: 'white',
                        boxShadow: '0px 4px 10px rgba(0,0,0,0.1)'
                    }}>
                        <HeaderSelector
                            setHeaderSelectorVisible={setHeaderSelectorVisible}
                            onHeadersReset={onHeadersReset}
                            space={space}
                            spaces={spaces}
                        />
                    </div>,
                    document.body
                )}
            </section>
        </div>
    )    
}

export default FilesHeader